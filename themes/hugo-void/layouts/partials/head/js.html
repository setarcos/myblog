{{- with resources.Get "js/main.js" }}
  {{- if eq hugo.Environment "development" }}
    {{- with . | js.Build }}
      <script src="{{ .RelPermalink }}"></script>
    {{- end }}
  {{- else }}
    {{- $opts := dict "minify" true }}
    {{- with . | js.Build $opts | fingerprint }}
      <script src="{{ .RelPermalink }}" integrity="{{- .Data.Integrity }}" crossorigin="anonymous"></script>
    {{- end }}
  {{- end }}
{{- end }}

<!-- JS & Library -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- KaTeX 数学公式支持 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

<!-- 代码块基础功能 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 数学公式渲染
    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false}
      ],
      throwOnError: false
    });
    
    // Enhanced code block with language label and copy button
    document.querySelectorAll('pre code').forEach(function(codeBlock) {
      // Get the programming language
      let language = '';
      codeBlock.className.split(' ').forEach(function(cls) {
        if (cls.startsWith('language-')) {
          language = cls.substring(9);
        }
      });
      
      // Get the original pre element and its parent container
      const pre = codeBlock.parentNode;
      const wrapper = pre.parentNode;
      
      // Create code block container
      const container = document.createElement('div');
      container.className = 'code-block-container';
      
      // Create header bar
      const header = document.createElement('div');
      header.className = 'code-block-header';
      
      // Display language label
      if (language) {
        const langLabel = document.createElement('span');
        langLabel.className = 'code-language-label';
        langLabel.textContent = language.toUpperCase();
        header.appendChild(langLabel);
      }
      
      // Add copy button
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg> Copy';
      
      copyButton.addEventListener('click', function() {
        // Get code content
        const code = codeBlock.textContent;
        
        // Copy to clipboard
        navigator.clipboard.writeText(code).then(function() {
          // Success, update button text
          copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied!';
          
          // Reset after 2 seconds
          setTimeout(function() {
            copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg> Copy';
          }, 2000);
        });
      });
      
      header.appendChild(copyButton);
      
      container.appendChild(header);
      // Replace the original pre with the container, then move the pre inside.
      if (pre.parentNode) {
        pre.parentNode.replaceChild(container, pre);
      }
      container.appendChild(pre);
      
      // Apply syntax highlighting
      if (window.hljs) hljs.highlightElement(codeBlock);
    });
  });
</script>
<!-- 脚注返回链接支持 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 处理脚注返回链接
    const footnoteBacklinks = document.querySelectorAll('.footnote-backref');
    
    footnoteBacklinks.forEach(function(backlink) {
      backlink.addEventListener('click', function(e) {
        e.preventDefault();
        
        // 获取链接的href属性（格式为 #fnref:1 等）
        const href = backlink.getAttribute('href');
        
        if (href) {
          // 找到原文引用的元素
          const target = document.querySelector(href);
          
          if (target) {
            // 滚动到引用位置
            target.scrollIntoView({ behavior: 'smooth' });
            
            // 高亮显示引用位置（可选）
            target.classList.add('footnote-highlight');
            setTimeout(function() {
              target.classList.remove('footnote-highlight');
            }, 2000);
          }
        }
      });
    });
  });
</script>

<!-- 页内跳转目标高亮（TOC/哈希链接） -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- Theme (dark / light) ---
    (function themeInit() {
      const storageKey = 'theme';
      const root = document.documentElement;
      const btn = document.getElementById('theme-toggle');
      const hlLight = document.getElementById('hljs-theme-light');
      const hlDark = document.getElementById('hljs-theme-dark');

      function systemPrefersDark() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      function currentPref() {
        const v = localStorage.getItem(storageKey);
        if (v === 'dark') return 'dark';
        if (v === 'light') return 'light';
        return systemPrefersDark() ? 'dark' : 'light';
      }

      function apply(theme) {
        root.classList.toggle('dark', theme === 'dark');
        if (btn) btn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
        if (btn) btn.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
        if (hlLight && hlDark) { hlLight.disabled = theme === 'dark'; hlDark.disabled = theme !== 'dark'; }
      }

      let theme = currentPref();
      apply(theme);

      if (btn) {
        btn.addEventListener('click', function () {
          theme = theme === 'dark' ? 'light' : 'dark';
          localStorage.setItem(storageKey, theme);
          apply(theme);
        });
      }

      // Watch system preference changes when user has no explicit choice
      try {
        const media = window.matchMedia('(prefers-color-scheme: dark)');
        const handler = function () {
          const explicit = localStorage.getItem(storageKey);
          if (!explicit) { theme = currentPref(); apply(theme); }
        };
        if (media && media.addEventListener) media.addEventListener('change', handler);
        else if (media && media.addListener) media.addListener(handler);
      } catch (_) {}
    })();
    let currentHighlighted = null;
    let scrollArmTimer = null;

    function removeHandlers() {
      window.removeEventListener('scroll', clearOnce);
      window.removeEventListener('keydown', clearOnce);
      window.removeEventListener('pointerdown', clearOnce);
      window.removeEventListener('touchstart', clearOnce);
    }

    function clearOnce() {
      if (currentHighlighted) {
        currentHighlighted.classList.remove('anchor-highlight');
        currentHighlighted = null;
      }
      removeHandlers();
    }

    function headerHeight() {
      const hd = document.querySelector('body > header');
      return hd ? hd.getBoundingClientRect().height : 0;
    }

    function scrollToTarget(el) {
      if (!el) return;
      const offset = headerHeight() + 8; // 头部高度 + 细微间距
      const rect = el.getBoundingClientRect();
      const top = window.pageYOffset + rect.top - offset;
      window.scrollTo({ top, behavior: 'smooth' });
    }

    function pickHighlightTarget(el) {
      if (!el) return null;
      // If the anchor itself is an inline math/image span, prefer the precise node
      // 1) Direct images
      if (el.tagName === 'IMG') return el;
      // 2) KaTeX nodes (inline or display)
      if (el.classList && (el.classList.contains('katex-display') || el.classList.contains('katex'))) return el;
      // 3) If it's a span wrapper, look for an img or KaTeX inside it
      if (el.tagName === 'SPAN') {
        const img = el.querySelector('img');
        if (img) return img;
        const kx = el.querySelector('.katex-display, .katex');
        if (kx) return kx;
        // Otherwise highlight the span itself (most precise inline target)
        return el;
      }
      // Prefer heading container when targeting headings
      const head = el.closest('h1,h2,h3,h4,h5,h6');
      if (head) return head;
      // Code block container
      const code = el.closest('.code-block-container');
      if (code) return code;
      // Display math (if ancestor)
      const math = el.closest('.katex-display');
      if (math) return math;
      // Other common block containers
      const blk = el.closest('pre,figure,table,blockquote,li');
      if (blk) return blk;
      // Avoid wrapping entire paragraphs when the element is inline; use itself
      if (el.closest('p')) return el;
      return el;
    }

    function highlightById(id) {
      if (!id) return;
      try { id = decodeURIComponent(id); } catch (e) {}
      const el = document.getElementById(id);
      if (!el) return;
      const target = pickHighlightTarget(el);
      if (currentHighlighted && currentHighlighted !== target) {
        currentHighlighted.classList.remove('anchor-highlight');
      }
      target.classList.add('anchor-highlight');
      currentHighlighted = target;
      // 高亮 TOC 中对应项
      setTocActive(id);
      scrollToTarget(target);
      // 下一次交互或超时清除
      removeHandlers();
      // 立刻监听键盘/指针，但延迟武装 scroll 清除，避免平滑滚动立即清掉高亮
      window.addEventListener('keydown', clearOnce, { once: true });
      window.addEventListener('pointerdown', clearOnce, { once: true });
      window.addEventListener('touchstart', clearOnce, { once: true });
      if (scrollArmTimer) clearTimeout(scrollArmTimer);
      scrollArmTimer = setTimeout(() => {
        window.addEventListener('scroll', clearOnce, { once: true });
      }, 1500);
    }

    // 页面初次加载带 hash
    if (location.hash && location.hash.length > 1) {
      // 等待初始布局完成再滚动与高亮
      setTimeout(() => highlightById(location.hash.slice(1)), 0);
    }

    // hash 变化时处理
    window.addEventListener('hashchange', function () {
      if (location.hash && location.hash.length > 1) {
        highlightById(location.hash.slice(1));
      }
    });

    // 事件委托：监听任意哈希内链（更稳健，兼容后续动态生成的目录等）
    document.addEventListener('click', function (e) {
      const a = e.target.closest('a[href^="#"]');
      if (!a) return;
      // Let heading-anchor clicks go to the copy handler
      if (a.classList && a.classList.contains('heading-anchor')) return;
      const href = a.getAttribute('href');
      if (!href || href === '#' || href.length < 2) return;
      const id = href.slice(1);
      if (!document.getElementById(id)) return; // 不是有效锚点
      e.preventDefault();
      if (history.pushState) { history.pushState(null, '', '#' + id); }
      else { location.hash = id; }
      highlightById(id);
    }, true);

    // 浏览器前进/后退时也处理
    window.addEventListener('popstate', function () {
      if (location.hash && location.hash.length > 1) highlightById(location.hash.slice(1));
    });

    function setTocActive(id) {
      try { id = decodeURIComponent(id); } catch (e) {}
      const toc = document.getElementById('TableOfContents');
      if (!toc) return;
      const esc = (window.CSS && CSS.escape) ? CSS.escape : (s)=>String(s).replace(/[^a-zA-Z0-9_\-]/g, '\\$&');
      toc.querySelectorAll('a.toc-active').forEach(a => a.classList.remove('toc-active'));
      const link = toc.querySelector('a[href="#' + esc(id) + '"]');
      if (link) link.classList.add('toc-active');
    }

    // Small helper to copy text to clipboard (secure + fallback)
    function copyText(text) {
      if (window.isSecureContext && navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise(function (resolve, reject) {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed'; ta.style.top = '-1000px'; ta.style.left = '-1000px'; ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          try { ta.setSelectionRange(0, ta.value.length); } catch (_) {}
          const ok = document.execCommand && document.execCommand('copy');
          document.body.removeChild(ta);
          ok ? resolve() : reject(new Error('copy failed'));
        } catch (e) { reject(e); }
      });
    }

    // Add small anchor buttons to headings that copy the section URL
    (function addHeadingAnchorCopy() {
      const container = document.querySelector('article .prose');
      if (!container) return;
      const heads = container.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
      heads.forEach((h) => {
        const id = h.getAttribute('id');
        if (!id) return;
        let a = h.querySelector('.heading-anchor');
        if (!a) {
          a = document.createElement('a');
          a.className = 'heading-anchor';
          a.href = '#' + id;
          a.setAttribute('aria-label', 'Copy link to this section');
          a.innerHTML = '<svg viewBox="0 0 1024 1024" width="18" height="18" fill="currentColor" aria-hidden="true"><path d="M633.417143 429.007238a174.567619 174.567619 0 0 1 0 246.857143l-155.306667 155.306667a186.709333 186.709333 0 1 1-264.045714-264.045715l76.483048-76.507428 51.73638 51.736381-76.507428 76.507428a113.566476 113.566476 0 1 0 160.597333 160.597334l155.306667-155.306667a101.424762 101.424762 0 0 0 0-143.408762z m208.603428-225.816381a186.709333 186.709333 0 0 1 0 264.045714L765.561905 543.744l-51.736381-51.712 76.507428-76.507429a113.566476 113.566476 0 1 0-160.597333-160.597333l-155.306667 155.306667a101.424762 101.424762 0 0 0 0 143.408762l-51.736381 51.736381a174.567619 174.567619 0 0 1 0-246.857143l155.306667-155.306667a186.709333 186.709333 0 0 1 264.045714 0z"/></svg>';
          h.appendChild(a);
        }
        function copyPermalink() {
          const url = location.origin + location.pathname + '#' + id;
          const done = function () {
            a.classList.add('copied');
            a.setAttribute('aria-label', 'Copied');
            setTimeout(() => { a.classList.remove('copied'); a.setAttribute('aria-label', 'Copy link to this section'); }, 1200);
          };
          copyText(url).then(done).catch(done);
        }
        a.addEventListener('click', function (e) { e.preventDefault(); e.stopPropagation(); copyPermalink(); });

        // Make the whole heading clickable (except when clicking an embedded link)
        h.classList.add('heading-clickable');
        h.addEventListener('click', function (e) {
          if (e.target.closest('a') && !e.target.closest('.heading-anchor')) return; // don't override normal links except our icon
          copyPermalink();
        });
      });

      // Also add a delegated handler so clicks are always caught
      document.addEventListener('click', function (e) {
        const btn = e.target.closest('a.heading-anchor');
        if (!btn) return;
        // Avoid interference from the global hash handler
        e.preventDefault(); e.stopPropagation();
        const href = btn.getAttribute('href') || '';
        const id = href.startsWith('#') ? href.slice(1) : '';
        const url = href.startsWith('#') ? (location.origin + location.pathname + href) : href;
        copyText(url).finally(() => {
          btn.classList.add('copied'); btn.setAttribute('aria-label', 'Copied');
          setTimeout(() => { btn.classList.remove('copied'); btn.setAttribute('aria-label', 'Copy link to this section'); }, 1200);
          if (id) {
            try { if (history.pushState) history.pushState(null, '', '#' + id); else location.hash = id; } catch (_) {}
            try { highlightById(id); } catch (_) {}
          }
        });
      }, false);
    })();
  });
</script>
