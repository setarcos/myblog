console.log("This site was generated by Hugo.");

// 处理脚注的返回链接
document.addEventListener("DOMContentLoaded", function () {

  // 先把 callout 内的脚注搬到页面底部的全局脚注区域
  relocateCalloutFootnotes();

  // 修复可能存在的 ID 问题
  fixFootnoteIds();

  // 查找所有脚注返回链接
  const backRefs = document.querySelectorAll(".footnote-backref");

  if (backRefs.length > 0) {
    backRefs.forEach((backref, index) => {
      // 获取返回链接的 href
      const href = backref.getAttribute("href");
      if (!href) return;

      // 使返回链接更明显
      backref.style.fontWeight = "bold";
      backref.style.fontSize = "1.2em";

      // 为每个返回链接添加点击事件
      backref.addEventListener("click", function (e) {
        e.preventDefault();
        const targetId = href.substring(1); // 移除 # 符号
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          // 滚动到引用位置
          targetElement.scrollIntoView({ behavior: "smooth" });

          // 添加突出显示效果
          targetElement.classList.add("footnote-highlight");
          setTimeout(() => {
            targetElement.classList.remove("footnote-highlight");
          }, 2000);
        }
      });
    });
  }

  // 处理从文章到脚注的链接
  const footnoteRefs = document.querySelectorAll(".footnote-ref");

  if (footnoteRefs.length > 0) {
    footnoteRefs.forEach((ref, index) => {
      const href = ref.getAttribute("href");

      ref.addEventListener("click", function (e) {
        e.preventDefault();
        const targetId = this.getAttribute("href").substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          targetElement.scrollIntoView({ behavior: "smooth" });
        }
      });
    });
  }
});

// 修复脚注 ID 相关问题
function fixFootnoteIds() {
  // 检查并修复脚注引用 ID
  const footnoteRefs = document.querySelectorAll('sup[id^="fnref"]');
  footnoteRefs.forEach((ref) => {
    const id = ref.id;
    const link = ref.querySelector("a");
    if (link) {
      const href = link.getAttribute("href");
      if (href) {
        // 确保链接指向正确的脚注
        const targetId = href.substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          // 确保脚注返回链接指向正确的引用
          const backref = target.querySelector(".footnote-backref");
          if (backref) {
            backref.setAttribute("href", "#" + id);
            console.log(
              `修复脚注返回链接: ${backref.getAttribute("href")} 指向 ${id}`
            );
          }
        }
      }
    }
  });
}

// 将 callout 中生成的脚注节点合并到页面底部的统一脚注列表
function relocateCalloutFootnotes() {
  const calloutFootnoteBlocks = Array.from(document.querySelectorAll('.callout .footnotes'));
  if (calloutFootnoteBlocks.length === 0) return;

  // 全局脚注容器（不在 callout 中）
  let globalFootnotes = Array.from(document.querySelectorAll('.footnotes'))
    .find(el => !el.closest('.callout'));

  // 文章内容容器（用于新建全局脚注时的插入位置）
  const contentRoot = document.querySelector('article .p-8.prose') || document.querySelector('.p-8.prose');

  if (!globalFootnotes) {
    // 创建全局脚注容器
    globalFootnotes = document.createElement('div');
    globalFootnotes.className = 'footnotes';
    const hr = document.createElement('hr');
    const ol = document.createElement('ol');
    globalFootnotes.appendChild(hr);
    globalFootnotes.appendChild(ol);
    if (contentRoot) {
      contentRoot.appendChild(globalFootnotes);
    } else {
      document.body.appendChild(globalFootnotes);
    }
  }

  const globalList = globalFootnotes.querySelector('ol') || (function(){
    const ol = document.createElement('ol');
    globalFootnotes.appendChild(ol);
    return ol;
  })();

  // 逐个搬运 callout 内的 <li>
  calloutFootnoteBlocks.forEach(block => {
    const list = block.querySelector('ol');
    if (!list) return;
    Array.from(list.children).forEach(li => {
      globalList.appendChild(li); // 保留原有 id，避免锚点失效
    });
    // 移除空容器
    block.remove();
  });
}
